varnishtest "3686: Server disconnects after reading the headers without sending a response"

barrier b1 cond 2

server s1 {
        rxreqhdrs
} -start

varnish v1 -vcl+backend {
	import vtc;

	sub vcl_backend_response {
        set beresp.http.br_uncacheable = beresp.uncacheable;
        set beresp.http.br_send_failed = bereq.send_failed;
        set beresp.http.br_fetch_failed = beresp.fetch_failed;
	}

	sub vcl_backend_error {
        set beresp.http.be_uncacheable = true;
        set beresp.http.be_send_failed = bereq.send_failed;
        set beresp.http.be_fetch_failed = beresp.fetch_failed;
	}

} -start

client c1 {
        txreq -method POST -hdr "Transfer-Encoding: chunked"
        chunkedlen 100
        barrier b1 sync
        chunkedlen 0
        rxresp
        expect resp.status == 503
        expect resp.reason == "Backend fetch failed"
        expect resp.http.be_uncacheable == true
        expect resp.http.be_send_failed == true
        expect resp.http.be_fetch_failed == true
} -start

server s1 -wait
barrier b1 sync
client c1 -wait

